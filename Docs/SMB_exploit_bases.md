# Les bases de l'attaque du protocole SMB


## Introduction

Le protocole SMB (Server Message Block) est un protocole de partage de fichiers et d'imprimantes sur un réseau local. Il est utilisé par Windows et Linux. Il est aussi utilisé par les ransomwares pour se propager sur un réseau local.
* Les clients se connectent aux serveurs en utilisant TCP/IP (en fait NetBIOS sur TCP/IP comme spécifié dans RFC1001 et RFC1002), NetBEUI ou IPX/SPX.
* Depuis Windows 95, les systèmes d'exploitation Microsoft Windows prennent en charge le protocole SMB pour les clients et les serveurs. Samba, un serveur open source qui prend en charge le protocole SMB, a été publié pour les systèmes Unix.

## Les ports les plus utilisés pour SMB


| Port | Description |
 | --- | --- |
 | 139 | NetBIOS Session Service |
 | 445 | SMB over TCP |
 
## Enumération SMB

Pour la détection de ports on a plusieurs outils à notre disposition. On peut utiliser **nmap**, **metasploit**, etc. Mais aussi **Enum4linux** qui est un outil qui permet de faire de l'enumération sur les serveurs SMB. Il est disponible sur Kali Linux.

Les informations importantes à récupérer sont :
* Les utilisateurs
* Les groupes
* Les localisations des partages (shares)
* Le nom des partages (shares)
* Le nom des machines

### Enum4linux

Pour utiliser Enum4linux il suffit de faire un :
```bash
enum4linux -a [ip de la cible]
```
Le -a permet de faire une enumération complète. Il y a d'autres options disponibles. Pour plus d'infos :
```bash
enum4linux -h
```
TAG | Description
--- | ---
```-a``` | All options
```-A``` | Do all simple enumeration (-U -M -S -G -P -r -o -n -i -L -d)
```-U``` | User list (-U: list users, -u: username, -p: password, -P: password policy)
```-M``` | Machine list (-M: list machines, -m: machine name)
```-S``` | Share list (-S: list shares, -s: sharename)
```-G``` | Group list (-G: list groups, -g: groupname)
```-P``` | Password policy information (-P: password policy)
```-r``` | RID cycling (default off)
```-o``` | OS information
```-n``` | Name information (default off)
```-i``` | User and group information (-i: list users and groups, -u: username, -g: groupname)
```-L``` | LDAP information (use with -i)
```-d``` | Dump all information (use with -i)

### Nmap

Pour utiliser nmap spécifiquement pour SMB sur ses ports habituels, il suffit de faire un :
```bash
nmap -p 139,445 --script smb-enum-shares.nse,smb-enum-users.nse [ip de la cible]
```
Pour plus d'infos sur les scripts nmap :
```bash
nmap --script-help smb-enum-shares.nse
```
TAG | Description
--- | ---
```smb-enum-shares``` | Enumerate SMB shares

### Metasploit

Pour utiliser metasploit pour faire de l'enumération sur SMB il faut utiliser le module ```auxiliary/scanner/smb/smb_enumshares```. Pour plus d'infos sur ce module :
```bash
use auxiliary/scanner/smb/smb_enumshares
```
TAG | Description
--- | ---
```set RHOSTS``` | The target address range or CIDR identifier
```set RHOST``` | The target address
```set RPORT``` | The target port (TCP)
```set THREADS``` | The number of concurrent threads
```set SMBDomain``` | The Windows domain to use for authentication
```set SMBPass``` | The password for the specified username
```set SMBUser``` | The username to authenticate as
  

## Exploitation SMB

### Vulnérabilités

* CVE-2017-7494
Cette vulnérabilité permet l'exécution de code à distance en exploitant SMB, il est plus probable que vous rencontriez une situation où le meilleur moyen d'entrer dans un système est dû à une mauvaise configuration du système. Dans ce cas, nous allons exploiter l'accès anonyme au partage SMB - une mauvaise configuration courante qui peut nous permettre d'obtenir des informations qui mèneront à un shell.

### SMBClient

Comme nous essayons d'accéder à un partage SMB, nous avons besoin d'un client pour accéder aux ressources des serveurs. Nous utiliserons SMBClient car il fait partie de la suite Samba par défaut.

syntaxe :
```bash
smbclient //[ip de la cible]/[nom du partage]
```
TAG | Description
--- | ---
```-L``` | List shares on the server
```-N``` | No password
```-U``` | Username
```-p``` | Port
```-I``` | IP address

### Test d'accès anonyme

Nous allons maintenant utiliser SMBClient pour accéder au partage SMB en tant qu'utilisateur anonyme. Nous utiliserons le partage IPC$ car il est utilisé pour accéder aux informations sur les utilisateurs et les groupes mais ce test peut être effectué sur n'importe quel partage SMB.

syntaxe :
```bash
smbclient //[ip de la cible]/IPC$ -N
```
On peut aussi essayer avec le nom d'utilisateur ```anonymous``` et le mot de passe ```anonymous```.

Ou avec le nom d'utilisateur ```guest``` et le mot de passe ```guest```.
