# SMTP : les bases

## Introduction

Le protocole SMTP (Simple Mail Transfer Protocol) est un protocole de communication utilisé pour transférer des messages électroniques entre des serveurs de messagerie. Il est utilisé pour envoyer des messages électroniques à partir d'un client de messagerie vers un serveur de messagerie et d'un serveur de messagerie vers un autre. Il est également utilisé pour transférer des messages électroniques entre différents serveurs de messagerie.

### Fonctionnement succinct du protocole SMTP

1. L'agent utilisateur de messagerie, qui est soit votre client de messagerie, soit un programme externe, se connecte au serveur SMTP de votre domaine, par exemple smtp.google.com. Ceci initie la poignée de main SMTP. Cette connexion fonctionne sur le port SMTP - qui est généralement 25. Une fois ces connexions établies et validées, la session SMTP démarre.
2. Le processus d'envoi du courrier peut maintenant commencer. Le client soumet d'abord au serveur l'adresse électronique de l'expéditeur et du destinataire, le corps du message et les éventuelles pièces jointes.
3. Le serveur SMTP vérifie ensuite si le nom de domaine du destinataire et celui de l'expéditeur sont identiques.
4. Le serveur SMTP de l'expéditeur établit une connexion avec le serveur SMTP du destinataire avant de relayer le courrier électronique. Si le serveur du destinataire n'est pas accessible ou n'est pas disponible, l'e-mail est placé dans une file d'attente SMTP.
5. Ensuite, le serveur SMTP du destinataire vérifie le courriel entrant. Pour ce faire, il vérifie si le domaine et le nom d'utilisateur ont été reconnus. Le serveur transfère ensuite le courriel au serveur POP ou IMAP, comme le montre le schéma ci-dessus.
6. Le message s'affichera alors dans la boîte de réception du destinataire.

Il s'agit d'une version très simplifiée du processus, et de nombreux sous-protocoles, communications et détails n'ont pas été inclus. Si vous souhaitez en savoir plus sur ce sujet, il s'agit d'une description très conviviale des détails techniques les plus fins - je l'ai d'ailleurs utilisée pour écrire cette description : [How SMTP works](https://computer.howstuffworks.com/e-mail-messaging/email3.htm)


## Enumeration

### Ports de base SMTP

Le port de base SMTP est le port 25. C'est du TCP/IP.

### Packet nécessaire

Des serveurs de messagerie mal configurés ou vulnérables peuvent souvent constituer un point d'ancrage initial dans un réseau, mais avant de lancer une attaque, nous voulons prendre l'empreinte du serveur afin de rendre notre ciblage aussi précis que possible. Pour ce faire, nous allons utiliser le module **smtp_version** de **MetaSploit**. Comme son nom l'indique, il analysera une plage d'adresses IP et déterminera la version de tous les serveurs de messagerie qu'il rencontrera.

Il est intéressant de noter que cette technique d'énumération fonctionnera pour la majorité des configurations SMTP ; cependant, il existe d'autres outils **non-metasploit** tels que **smtp-user-enum** qui fonctionnent encore mieux pour énumérer les comptes utilisateurs au niveau du système d'exploitation sur Solaris via le service SMTP. L'énumération est réalisée en inspectant les réponses aux commandes VRFY, EXPN, et RCPT TO.

### Commandes internes SMTP

Le service SMTP dispose de deux commandes internes qui permettent d'énumérer les utilisateurs : **VRFY** (qui confirme les noms des utilisateurs valides) et **EXPN** (qui révèle l'adresse réelle des alias et des listes de courrier électronique de l'utilisateur (listes de diffusion). En utilisant ces commandes SMTP, nous pouvons révéler une liste d'utilisateurs valides

### Enumération de SMTP

Nous pouvons le faire manuellement, via une connexion telnet, mais Metasploit vient à nouveau à la rescousse, en fournissant un module pratique appelé **smtp_enum** qui fera le travail à notre place ! Pour utiliser le module, il suffit de lui fournir un hôte ou une plage d'hôtes à analyser et une liste de mots contenant des noms d'utilisateurs à énumérer.

Pour la wordlist à utiliser pour tester les utilisateurs, nous pouvons utiliser la wordlist **/usr/share/wordlists/metasploit/unix_users.txt** qui contient une liste de noms d'utilisateurs courants.
Mais j'ai utilisé seclist : [seclist github](https://github.com/danielmiessler/SecLists)

```bash
msf6 > use auxiliary/scanner/smtp/smtp_enum
msf6 auxiliary(scanner/smtp/smtp_enum) > set RHOSTS [ip]
RHOSTS => [ip]
msf6 auxiliary(scanner/smtp/smtp_enum) > set USER_FILE /usr/share/seclist/Usernames/top-usernames-shortlist.txt
USER_FILE => /usr/share/seclist/Usernames/top-usernames-shortlist.txt
msf6 auxiliary(scanner/smtp/smtp_enum) > run
```


## Exploitation

### Bruteforce d'un utilisateur

Une fois qu'on a obtenu l'id d'un utilisateur, si un port SSH ou autre est ouvert sur la machine, on peut essayer de le bruteforce avec Hydra par exemple.