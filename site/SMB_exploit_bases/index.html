<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://cyber-puit-de-connaissances.com/SMB_exploit_bases/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Les exploits du protocole SMB - Cyber-puit de connaissances</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Les exploits du protocole SMB";
        var mkdocs_page_input_path = "SMB_exploit_bases.md";
        var mkdocs_page_url = "/SMB_exploit_bases/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Cyber-puit de connaissances
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../accueil/">Accueil</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Outils</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Nmap</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../nmap_bases_scan/">Les scans</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../nmap_bases_utiles/">Utile</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Metasploit</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../metasploit_bases/">Les bases</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../metasploit_exploits/">Les exploits</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Réseau</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../changer_DNS_windows/">Changer DNS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Système</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">BIOS</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="#">Accès au hardware</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../reset_mdp_BIOS_hardware_PC_fixe/">PC fixe</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../reset_mdp_BIOS_hardware_PC_portable/">PC portable</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Cyber-puit de connaissances</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>Les exploits du protocole SMB</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="les-exploits-du-protocole-smb">Les exploits du protocole SMB</h1>
<h2 id="introduction">Introduction</h2>
<p>Le protocole SMB (Server Message Block) est un protocole de partage de fichiers et d'imprimantes sur un réseau local. Il est utilisé par Windows et Linux. Il est aussi utilisé par les ransomwares pour se propager sur un réseau local.
* Les clients se connectent aux serveurs en utilisant TCP/IP (en fait NetBIOS sur TCP/IP comme spécifié dans RFC1001 et RFC1002), NetBEUI ou IPX/SPX.
* Depuis Windows 95, les systèmes d'exploitation Microsoft Windows prennent en charge le protocole SMB pour les clients et les serveurs. Samba, un serveur open source qui prend en charge le protocole SMB, a été publié pour les systèmes Unix.</p>
<h2 id="les-ports-les-plus-utilises-pour-smb">Les ports les plus utilisés pour SMB</h2>
<ul>
<li>| Port | Description |</li>
<li>| --- | --- |</li>
<li>| 139 | NetBIOS Session Service |</li>
<li>| 445 | SMB over TCP |</li>
</ul>
<h2 id="enumeration-smb">Enumération SMB</h2>
<p>Pour la détection de ports on a plusieurs outils à notre disposition. On peut utiliser <strong>nmap</strong>, <strong>metasploit</strong>, etc. Mais aussi <strong>Enum4linux</strong> qui est un outil qui permet de faire de l'enumération sur les serveurs SMB. Il est disponible sur Kali Linux.</p>
<p>Les informations importantes à récupérer sont :
* Les utilisateurs
* Les groupes
* Les localisations des partages (shares)
* Le nom des partages (shares)
* Le nom des machines</p>
<h3 id="enum4linux">Enum4linux</h3>
<p>Pour utiliser Enum4linux il suffit de faire un :</p>
<pre><code class="language-bash">enum4linux -a [ip de la cible]
</code></pre>
<p>Le -a permet de faire une enumération complète. Il y a d'autres options disponibles. Pour plus d'infos :</p>
<pre><code class="language-bash">enum4linux -h
</code></pre>
<ul>
<li>TAG | Description</li>
<li>--- | ---</li>
<li><code>-a</code> | All options</li>
<li><code>-A</code> | Do all simple enumeration (-U -M -S -G -P -r -o -n -i -L -d)</li>
<li><code>-U</code> | User list (-U: list users, -u: username, -p: password, -P: password policy)</li>
<li><code>-M</code> | Machine list (-M: list machines, -m: machine name)</li>
<li><code>-S</code> | Share list (-S: list shares, -s: sharename)</li>
<li><code>-G</code> | Group list (-G: list groups, -g: groupname)</li>
<li><code>-P</code> | Password policy information (-P: password policy)</li>
<li><code>-r</code> | RID cycling (default off)</li>
<li><code>-o</code> | OS information</li>
<li><code>-n</code> | Name information (default off)</li>
<li><code>-i</code> | User and group information (-i: list users and groups, -u: username, -g: groupname)</li>
<li><code>-L</code> | LDAP information (use with -i)</li>
<li><code>-d</code> | Dump all information (use with -i)</li>
</ul>
<h3 id="nmap">Nmap</h3>
<p>Pour utiliser nmap spécifiquement pour SMB sur ses ports habituels, il suffit de faire un :</p>
<pre><code class="language-bash">nmap -p 139,445 --script smb-enum-shares.nse,smb-enum-users.nse [ip de la cible]
</code></pre>
<p>Pour plus d'infos sur les scripts nmap :</p>
<pre><code class="language-bash">nmap --script-help smb-enum-shares.nse
</code></pre>
<ul>
<li>TAG | Description</li>
<li>--- | ---</li>
<li><code>smb-enum-shares</code> | Enumerate SMB shares</li>
</ul>
<h3 id="metasploit">Metasploit</h3>
<p>Pour utiliser metasploit pour faire de l'enumération sur SMB il faut utiliser le module <code>auxiliary/scanner/smb/smb_enumshares</code>. Pour plus d'infos sur ce module :</p>
<pre><code class="language-bash">use auxiliary/scanner/smb/smb_enumshares
</code></pre>
<table>
<thead>
<tr>
<th>TAG</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>set RHOSTS</code></td>
<td>The target address range or CIDR identifier</td>
</tr>
<tr>
<td><code>set RHOST</code></td>
<td>The target address</td>
</tr>
<tr>
<td><code>set RPORT</code></td>
<td>The target port (TCP)</td>
</tr>
<tr>
<td><code>set THREADS</code></td>
<td>The number of concurrent threads</td>
</tr>
<tr>
<td><code>set SMBDomain</code></td>
<td>The Windows domain to use for authentication</td>
</tr>
<tr>
<td><code>set SMBPass</code></td>
<td>The password for the specified username</td>
</tr>
<tr>
<td><code>set SMBUser</code></td>
<td>The username to authenticate as</td>
</tr>
</tbody>
</table>
<h2 id="exploitation-smb">Exploitation SMB</h2>
<h3 id="vulnerabilites">Vulnérabilités</h3>
<ul>
<li>CVE-2017-7494
Cette vulnérabilité permet l'exécution de code à distance en exploitant SMB, il est plus probable que vous rencontriez une situation où le meilleur moyen d'entrer dans un système est dû à une mauvaise configuration du système. Dans ce cas, nous allons exploiter l'accès anonyme au partage SMB - une mauvaise configuration courante qui peut nous permettre d'obtenir des informations qui mèneront à un shell.</li>
</ul>
<h3 id="smbclient">SMBClient</h3>
<p>Comme nous essayons d'accéder à un partage SMB, nous avons besoin d'un client pour accéder aux ressources des serveurs. Nous utiliserons SMBClient car il fait partie de la suite Samba par défaut.</p>
<p>syntaxe :</p>
<pre><code class="language-bash">smbclient //[ip de la cible]/[nom du partage]
</code></pre>
<ul>
<li>TAG | Description</li>
<li>--- | ---</li>
<li><code>-L</code> | List shares on the server</li>
<li><code>-N</code> | No password</li>
<li><code>-U</code> | Username</li>
<li><code>-p</code> | Port</li>
<li><code>-I</code> | IP address</li>
</ul>
<h3 id="test-dacces-anonyme">Test d'accès anonyme</h3>
<p>Nous allons maintenant utiliser SMBClient pour accéder au partage SMB en tant qu'utilisateur anonyme. Nous utiliserons le partage IPC$ car il est utilisé pour accéder aux informations sur les utilisateurs et les groupes mais ce test peut être effectué sur n'importe quel partage SMB.</p>
<p>syntaxe :</p>
<pre><code class="language-bash">smbclient //[ip de la cible]/IPC$ -N
</code></pre>
<p>On peut aussi essayer avec le nom d'utilisateur <code>anonymous</code> et le mot de passe <code>anonymous</code>.</p>
<p>Ou avec le nom d'utilisateur <code>guest</code> et le mot de passe <code>guest</code>.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
